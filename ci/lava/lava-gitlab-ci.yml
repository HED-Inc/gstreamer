.lava-test:
  # Cancel job if a newer commit is pushed to the same branch
  interruptible: true
  stage: test
  variables:
    GIT_STRATEGY: none # testing doesn't build anything from source
    FDO_CI_CONCURRENT: 6 # should be replaced by per-machine definitions
    # proxy used to cache data locally
    FDO_HTTP_CACHE_URI: "http://caching-proxy/cache/?uri="
    # base system generated by the container build job, shared between many pipelines
  script:
    - lavacli identities add --token ${LAVA_TOKEN} --uri ${LAVA_URI} --username ${LAVA_USERNAME} default
    - ./artifacts/lava/lava-submit.sh
  artifacts:
    name: "${CI_PROJECT_NAME}_${CI_JOB_NAME}"
    when: always
    paths:
      - results/
    exclude:
      - results/*.shader_cache
    reports:
      junit: results/junit.xml
  tags:
    - gstreamer
  after_script:
    - curl -L --retry 4 -f --retry-all-errors --retry-delay 60 -s "https://${JOB_RESULTS_PATH}" | tar --zstd -x

.ci-artifacts:
  artifacts:
    name: "gstreamer_${CI_JOB_NAME}"
    when: always
    untracked: false
    paths:
      # Watch out!  Artifacts are relative to the build dir.
      # https://gitlab.com/gitlab-org/gitlab-ce/commit/8788fb925706cad594adf6917a6c5f6587dd1521
      - artifacts
#      - _build/meson-logs/*.txt
#      - _build/meson-logs/strace

.lava-test:arm64:
  variables:
    ARCH: arm64
    DEBIAN_ARCH: arm64
    KERNEL_IMAGE_NAME: Image.gz
    BOOT_METHOD: depthcharge
  extends:
    - .use-debian/arm64_build # for same $GSTREAMER_ARTIFACTS_TAG as in kernel+rootfs_arm64
    - .use-debian/x86_64_build
    - .lava-test
    - .use-kernel+rootfs-arm
    - .setup-s3
  dependencies:
    - build-for-lava:arm64
    - debian/x86_64_build
  needs:
#    - !reference [.lava-test, needs]
    - kernel+rootfs_arm64
    - build-for-lava:arm64
    - debian/x86_64_build

.lava-fluster:arm64:
  variables:
    FLUSTER_VECTORS_MAINLINE_HOST_PATH: "${BASE_SYSTEM_HOST_PREFIX}/${FDO_UPSTREAM_REPO}/fluster-vectors/${FLUSTER_REVISION}/${FLUSTER_VECTORS_VERSION}"
    FLUSTER_VECTORS_FORK_HOST_PATH: "${BASE_SYSTEM_HOST_PREFIX}/${CI_PROJECT_PATH}/fluster-vectors/${FLUSTER_REVISION}/${FLUSTER_VECTORS_VERSION}"
    FLUSTER_RESULTS: "${CPU_VERSION}-${FLUSTER_CODEC}"
    HWCI_TEST_SCRIPT: "/install/fluster/fluster-runner.sh"
  extends:
    - .lava-test:arm64

